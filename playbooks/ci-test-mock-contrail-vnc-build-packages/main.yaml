---

- hosts: all
  tasks:

#  - name: Prepare packaging variables
#    contrail_packaging:  # XXX unrecognized
#      zuul: "{{ zuul }}"
#      release_type: "{{ release_type }}"
#      build_number: "{{ build_number | default('unset_build_number') }}"

  - name: set repository url
    set_fact:
      nexus_repo_url: 'http://{{ nexus.fqdn }}/repository/yum-tungsten-nightly/master-538-centos'

  - name: list rpm files from a nightly job
    uri:
      url: 'http://ci-nexus.englab.juniper.net/service/rest/v1/search/assets?repository=yum-tungsten-nightly&version=5.1.0-538.el7'
      return_content: yes
    register: package_list

  - debug:
      msg: "{{ package_list.content | from_json | json_query('items[*].downloadUrl') | join('\n') | regex_findall('.*-centos.*') }}"

  - name: download all rpm
    uri:
      url: "{{ item }}"
      dest: "{{ ansible_env.HOME }}/{{ packaging.target_dir }}"
    vars:
      json_filter: "items[?contains(downloadUrl, '-centos')].downloadUrl"
    with_items: "{{ package_list.content | from_json | json_query(json_filter) }}"

  - name: return repository location back to zuul for children jobs
    zuul_return:
      data:
        contrail_package_repository: '{{ nexus_repo_url }}'
    delegate_to: localhost
    when: zuul_execution_trusted
