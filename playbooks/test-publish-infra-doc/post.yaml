---
- hosts: all
  roles:
    - role: fetch-docs
      fetch_src_path: '{{ zuul.projects | selectattr("short_name", "equalto", "contrail-infra-doc") | map(attribute="src_dir") | list | first }}/build/html'
      fetch_dst_path: "{{ zuul.executor.work_root }}/build/"

# - hosts: localhost
#   gather_facts: False
#   pre_tasks:
#     - name: Create src_dir
#       file:
#         path: "{{ zuul.executor.work_root }}/build/html"
#         state: directory

#     - name: Create a file in the docs directory
#       copy:
#         dest: "{{ zuul.executor.work_root }}/build/html/index.html"
#         content: foo

- hosts: builder
  gather_facts: False
  pre_tasks:
    - name: Create src_dir
      file:
        path: "var/www/static/infra-doc/"
        state: directory

  roles:
    - role: upload-docs
      zuul_docserver_root: "var/www/static/infra-doc"
      docs_dir: "{{ zuul.executor.work_root }}/build/html/"

  post_tasks:
    - name: List files
      command: ls
      args:
        chdir: var/www/static/infra-doc/

    - name: Check if files were uploaded correctly
      stat:
        path: "var/www/static/infra-doc/index.html"
      register: docs_dir_stat
      failed_when: not docs_dir_stat.stat.exists

    # - name: Clean up data
    #   file:
    #     state: absent
    #     path: "var/www"
