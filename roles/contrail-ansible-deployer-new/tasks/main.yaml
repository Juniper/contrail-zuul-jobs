- name: Install build dependencies
  package:
    name: "{{ item }}"
    state: present
  become: true
  with_items:
    - ansible

- name: Copy hosts template
  template:
    src: instances.j2
    dest: "{{ docker_provision_dir }}/config/instances.yaml"

- name: Provision Contrail with deploy.yml playbook
  command: >
    ansible-playbook -i inventory/ playbooks/configure_instances.yml -v
  args:
    chdir: "{{ docker_provision_dir }}"
  environment:
    ANSIBLE_HOST_KEY_CHECKING: 'False'
    ANSIBLE_STDOUT_CALLBACK: debug
  become: True

- name: Provision Contrail with deploy.yml playbook
  command: >
    ansible-playbook -i inventory/ -e orchestrator=openstack playbooks/install_contrail.yml
  args:
    chdir: "{{ docker_provision_dir }}"
  environment:
    ANSIBLE_HOST_KEY_CHECKING: 'False'
    ANSIBLE_STDOUT_CALLBACK: debug
  become: True

- name: Show the list of running containers
  command: docker ps -a
  become: True

- name: Show processes
  command: ps aux --sort rss

- name: Show memory usage
  command: free -m
