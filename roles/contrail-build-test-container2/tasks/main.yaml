- name: Set paths
  set_fact:
    test_container_build_dir: "{{ ansible_env.HOME }}/src/review.opencontrail.org/Juniper/contrail-test"
    rpm_repo_config_dir: /etc/yum.repos.d

- name: Get list of repo files
  find:
    paths: "{{ rpm_repo_config_dir }}/"
  register: repo_file_list

- name: Copy the repo files to containers build context
  copy:
    src: "{{ item.path }}"
    dest: "{{ test_container_build_dir }}/docker/test/{{ item.path | basename }}"
    remote_src: true
  with_items:
    - "{{ repo_file_list.files }}"

#XXX: finish seperating mirror preparation role
- name: Copy the repo files to containers build context
  copy:
    src: "{{ item.path }}"
    dest: "{{ test_container_build_dir }}/docker/base/{{ item.path | basename }}"
    remote_src: true
  with_items:
    - "{{ repo_file_list.files }}"

- name: Check if Zuul overrode the registry port
  stat:
    path: "{{ zuul.executor.work_root }}/saved_vars.yaml"
  register: varfile
  delegate_to: localhost

- name: Get the overridden registry port
  include_vars:
    file: "{{ zuul.executor.work_root }}/saved_vars.yaml"
  when: varfile.stat.isreg is defined and varfile.stat.isreg

- name: Set default registry port if not overridden
  set_fact:
    registry_port: "{{ docker_registry.port }}"
    contrail_docker_registry: "10.84.5.81:35278"
    contrail_docker_registry2: "10.84.5.81:35278"
    main_reg: "10.84.5.81:5000"
    contrail_container_tag: "5.0-31"
    contrail_container_tag2: "5.0-31"
    contrail_package_repository: "http://10.84.5.81/pulp/repos/5.0-31-centos"
    contrail_package_repository2: "http://10.84.5.81/pulp/repos/5.0-31-centos"
  when: registry_port is not defined

- name: Build container contrail-test-base
  shell: |
    ./build-container.sh base \
    --registry-server {{ contrail_docker_registry2 }} \
    --tag 5.0-31
  become: true
  args:
    chdir: "{{ test_container_build_dir }}"
  tags:
    - skip_ansible_lint # ANSIBLE0013

- name: Build test containers
  include: build_container.yaml
  with_items:
   - ocata
   - newton
