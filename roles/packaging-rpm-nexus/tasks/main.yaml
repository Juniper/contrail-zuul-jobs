---
- name: Prepare packaging variables
  contrail_packaging:
    zuul: '{{ zuul }}'
    release_type: '{{ release_type }}'
    build_number: "{{ build_number | default('no_build_number') }}"
    openstack_version: "{{ openstack_version | default('') }}"

- name: get a list of package files
  find:
    paths: "{{ ansible_env.HOME }}/{{ zuul.projects | selectattr('short_name', 'equalto', 'contrail-third-party-packages') | map(attribute='src_dir') | list | first }}/../RPMS"
    recurse: yes
    patterns:
      - '*.rpm'
  register: package_list

- name: check if directory contains packages to upload
  meta: end_play
  when: package_list.matched|int == 0

- name: upload rpms
  block:
    - name: create a credentials file
      copy:
        content: '--user {{ nexus_credentials.user }}:{{ nexus_credentials.password }}'
        dest: '{{ ansible_env.HOME  }}/nexus-creds'
      # no_log: true

    - name: upload rpm to nexus repo
      command: |
        curl -K {{ ansible_env.HOME }}/nexus-creds \
          --upload-file {{ item }} http://{{ nexus.fqdn }}/repository/{{ nexus.repos.yum }}/{{ repo_name }}/
      with_items: "{{ package_list | json_query('files[*].path') }}"
      tags:
        # ANSIBLE0006 - can not use either get_url or uri modules for this task
        # they do not support uploads (uri does since ansible 2.6)
        - skip_ansible_lint

  always:
    - name: remove credentials file
      file:
        path: '{{ ansible_env.HOME  }}/nexus-creds'
        state: 'absent'
      # no_log: true
