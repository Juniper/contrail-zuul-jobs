- name: Enable EPEL repository (RedHat)
  command: yum-config-manager --enable epel
  become: True

# XXX(kklimonda): seems like EPEL repomd.xml is not deleted by configure-mirrors
#   and our EPEL mirror is too old to override cache. Nuke the cache from orbit.
- name: clean-up yum cache
  command: "{{ item }}"
  become: True
  with_items:
    - yum clean all

# XXX(kklimonda): workaround for yum-builddep force-enabling non-existing repo
- name: Remove epel-source repository completely (RedHat)
  command: sed -e '/\[epel-source\]/,+6 s/^/#/' -i /etc/yum.repos.d/epel.repo
  become: True

- name: Install package dependencies for the build (RedHat)
  command: yum-builddep -y "{{ ansible_env.HOME }}/{{ packaging.target_dir }}/tools/packages/rpm/contrail/contrail.spec"
  become: True

# DPDK is built from the same sources, but the dependencies were split
# to another source package, so make sure we also install them.
- name: Install DPDK build dependencies (RedHat)
  command: yum-builddep -y "{{ ansible_env.HOME }}/{{ packaging.target_dir }}/tools/packaging/common/rpm/contrail-vrouter-dpdk.spec"
  become: True

# XXX(kklimonda) contrail-vrouter-dpdk.spec does not provide correct BuildDepends
- name: Install liburcu-devel package (RedHat)
  yum:
    name: liburcu-devel
    state: present
  become: True

- name: Fetch third-party dependencies
  command: "python fetch_packages.py --site-mirror http://{{ zuul_site_mirror_fqdn }}"
  args:
    chdir: "{{ packaging.target_dir }}/third_party/"

