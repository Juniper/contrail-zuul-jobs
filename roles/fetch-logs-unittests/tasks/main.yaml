---

- name: set variables
  set_fact:
    unittest_target_file: 'unittest_list.txt'
    results_dir: '{{ ansible_env.HOME }}/unittest_output'

- name: check that the Scons describe tests file exists
  stat:
    path: '{{ ansible_env.HOME }}/{{ unittest_target_file }}'
  register: unittest_stat

- name: fetch unit test's results
  when: unittest_stat.stat.exists
  block:
  - name: create directory for unittest restults
    file:
      path: '{{ results_dir }}'
      state: 'directory'
      owner: 'zuul'
      mode: 0755

  - name: create unittest submodules list
    convert_target_list:
      description_file: '{{ ansible_env.HOME }}/{{ unittest_target_file }}'
      target_file: '{{ results_dir }}/unittest_targets.json'
      strip_prefix: '{{ packaging.target_dir }}'

  - slurp:
    path: '{{ results_dir }}/unittest_targets.json'
    register: unittest_file

  - name: set targets in variable
    set_fact:
      unittest_targets: '{{ unittest_file.content | b64decode | from_json }}'

  - include_tasks: logs.yaml

  - include_tasks: xmls.yaml

- name: fetch unittests output to executor
  synchronize:
    src: '{{ results_dir }}'
    dest: '{{ zuul.executor.log_root }}/unittest_output/'
    mode: 'pull'

