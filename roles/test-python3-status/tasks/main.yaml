---

- name: copy and change permission of files
  copy:
    src: "{{ item }}"
    dest: "."
    mode: '0755'
  with_items:
    - python3-status-check.sh
    - requirements.txt


- name: Download repo binary
  get_url:
    url: https://storage.googleapis.com/git-repo-downloads/repo
    dest: /usr/bin/repo
    mode: '0755'
  become: true

- name: repo sync controller
  shell: |
    repo init --no-clone-bundle -q -u https://github.com/Juniper/contrail-vnc -b master
    repo sync --no-clone-bundle -q contrail-controller
  become: true

- name: Create a directory if it does not exist
  file:
    path: artifacts
    state: directory
    mode: '0755'

- name: run python3 status check script
  command: "bash python3-status-check.sh --report artifacts/python3-status-report.xml 2> errors.txt"
  become: true

- name: Check artifacts directory exists
  stat:
    path: 'artifacts'
  register: artifacts_logdir
  become: true


- name: Find the tests report xml file
  find:
    paths: '{{ artifacts_logdir }}'
    pattern: '*.xml'
    recurse: true
  become: true
  register: xml_report_file


- name: Fetch xml report files
  synchronize:
    src: '{{ item.path }}'
    dest: '{{ zuul.executor.log_root }}/artifacts'
    mode: 'pull'
  become: true
  with_items: '{{ xml_report_file.files }}'
  when: xml_report_file.matched > 0

