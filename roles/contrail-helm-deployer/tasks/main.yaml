- name: Set variables
  set_fact:
    repos_dir: "{{ ansible_env.HOME }}/src/{{ zuul.project.canonical_hostname }}/Juniper"

- name: Acquire IP address on the second interface
  command: /usr/sbin/dhclient ens4
  become: true
  become_user: root

- name: Get IP address for the second interface
  shell: |
    ip route show | grep ens4 | cut -d' ' -f12
  register: ens4_ip_addr

# TODO Change this to zuul-merger prepared checkouts
- name: Clone test repositories
  git:
    repo: "https://github.com/{{ item.org }}/{{ item.name }}"
    dest: "{{ repos_dir }}/{{ item.name }}"
    version: "{{ item.version | default('master') }}"
  with_items:
    - { org: Juniper, name: contrail-helm-deployer }
    - { org: madhukar32, name: openstack-helm, version: contrail_5_0 }
    - { org: madhukar32, name: openstack-helm-infra, version: contrail_5_0 }

- name: run helm deployment script
  script: helm-deploy.sh
  environment:
    BASE_DIR: "{{ repos_dir }}"
    OSH_PATH: "{{ repos_dir }}/openstack-helm"
    OSH_INFRA_PATH: "{{ repos_dir }}/openstack-helm-infra"
    CHD_PATH: "{{ repos_dir }}/contrail-helm-deployer"
    CONTROLLER_NODE: "{{ ens_ipv4_addr.stdout_lines }}"
    CONFIG_NODE: "{{ ens_ipv4_addr.stdout_lines }}"
