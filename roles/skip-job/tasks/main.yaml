---

- name: change mode of private key
  file:
    path: '{{ ansible_env.HOME }}/review-creds'
    mode: 0600

- name: find the current patchset
  shell: "ssh -i '{{ ansible_env.HOME }}/review-creds' -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p 29418 gerrit@review.opencontrail.org gerrit query --comments {{ zuul.change }} --current-patch-set  | grep -A 1 'currentPatchSet:' | grep 'number' | cut -d ':' -f2 | xargs"
  register: current_patch_set

- name: find passed jobs
  shell: "ssh -i '{{ ansible_env.HOME }}/review-creds' -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p 29418 gerrit@review.opencontrail.org gerrit query --comments {{ zuul.change }} | grep 'contrail-vnc-unittest-centos7' | grep ': SUCCESS in' | grep '/{{ current_patch_set.stdout_lines[1] }}/' | tr -s ' ' | cut -d ' ' -f3"
  register: passed_job

- name: display message
  debug:
    msg: "The var value {{ passed_job.stdout_lines[1] }} {{ ansible_env.HOME }}"

- name: display passed job
  debug:
    msg: "The skipped job is {{ passed_job.stdout_lines[1] }}"
  when: passed_job.stdout_lines[1] == "contrail-vnc-unittest-centos7"

- name: display message
  debug:
    msg: "The job {{ zuul.job }} hasn't run before and will run a full build"
  when: passed_job.stdout_lines[1] != "contrail-vnc-unittest-centos7"

- meta: end_play
  when: passed_job.stdout_lines[1] == "contrail-vnc-unittest-centos7"
  become: true
