---

- name: template ose-install inventory file
  template:
    src: 'ose-install_{{ openshift_version }}.j2'
    dest: '{{ zuul_project_dir }}/inventory/ose-install'
    force: true

- name: fetch ose-install to executor
  synchronize:
    src: '{{ zuul_project_dir }}/inventory/ose-install'
    dest: '{{ zuul.executor.log_root }}/'
    mode: 'pull'

# this binary is required on ansible control host while running
# deploy_cluster playbook during metric installation phase
- name: install additional requirements for cluster deployment phase
  package:
    name: '{{ item }}'
    state: 'present'
  with_items:
    - 'apache2-utils'
    - 'python-passlib'
  become: true

- name: run playbooks/prerequisites.yml playbook
  command: 'ansible-playbook -i inventory/ose-install playbooks/prerequisites.yml'
  args:
    chdir: '{{ zuul_project_dir }}'
  become: true

- name: run playbooks/deploy_cluster.yml playbook
  command: 'ansible-playbook -i inventory/ose-install playbooks/deploy_cluster.yml'
  args:
    chdir: '{{ zuul_project_dir }}'
  become: true

- name: prepare template for testrunner
  template:
    src: 'openshift_config.yaml.j2'
    dest: '{{ ansible_env.HOME }}/contrail_test_input.yaml'

- name: fetch contrail_test_input.yaml to executor
  synchronize:
    src: '{{ ansible_env.HOME }}/contrail_test_input.yaml'
    dest: '{{ zuul.executor.log_root }}/'
    mode: 'pull'

