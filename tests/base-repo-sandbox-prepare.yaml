- name: Test the repo-sandbox-prepare role
  hosts: all
  pre_tasks:
    - name: Create Juniper/contrail-vnc directory hierarchy
      file:
        path: "src/review.opencontrail.org/Juniper/contrail-vnc"
        state: directory
        recurse: true
    - name: Stub the contrail-vnc manifest XML file
      copy:
        src: fixtures/manifest-stub.xml
        dest: "src/review.opencontrail.org/Juniper/contrail-vnc/default.xml"
    # contrail-common-libs can only be executed in a trusted context,
    # so we can't really test it fully right now.
    - name: Stub the packaging fact
      set_fact:
        packaging:
          target_dir: "contrail-master"
  roles:
    - repo-sandbox-prepare2
  post_tasks:
    - name: stat the .repo/manifest.xml file
      stat:
        path: "{{ packaging.target_dir }}/.repo/manifest.xml"
      register: manifest
    - fail:
        msg: "manifest.xml does not exist or link is broken"
      when: "not (manifest.stat.islnk is defined and manifest.stat.islnk)"
    - name: Ensure that the repositories has been properly placed
      file:
        path: "{{ packaging.target_dir }}/{{ item.value.short_name }}/.git/HEAD"
        state: file
      with_dict: "{{ zuul._projects }}"
    - name: Ensure that all sandbox repositories have a working remote
      command: "git branch -r"
      args:
        chdir: "{{ packaging.target_dir }}/{{ item.value.short_name }}/"
      register: remotes
      failed_when: "'origin/{{ zuul.branch }}' not in remotes.stdout"
      with_dict: "{{ zuul._projects }}"

