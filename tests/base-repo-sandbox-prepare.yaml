- name: Test the repo-sandbox-prepare role
  hosts: all
  pre_tasks:
    - name: Create Juniper/contrail-vnc directory hierarchy
      file:
        path: "src/review.opencontrail.org/Juniper/contrail-vnc"
        state: directory
        recurse: true
    - name: Stub the contrail-vnc manifest XML file
      copy:
        src: fixtures/manifest-stub.xml
        dest: "src/review.opencontrail.org/Juniper/contrail-vnc/default.xml"
    # contrail-common-libs can only be executed in a trusted context,
    # so we can't really test it fully right now.
    - name: Stub the packaging fact
      set_fact:
        packaging:
          target_dir: "contrail-master"
  roles:
    - repo-sandbox-prepare2
  post_tasks:
    - name: Ensure that the sandbox has been prepared
      file:
        path: "{{ packaging.target_dir }}/.repo/manifest.xml"
        state: file
    - name: Ensure that the repositories has been properly placed
      file:
        path: "{{ packaging.target_dir }}/{{ item.value.short_name }}/.git/"
      with_dict: "{{ zuul._projects }}"
    - name: Ensure that all sandbox repositories have a working remote
      shell: "git branch -r | grep -q origin/{{ zuul.branch }}"
      args:
        chdir: "{{ packaging.target_dir }}/{{ item.value.short_name }}/"
      with_dict: "{{ zuul._projects }}"
