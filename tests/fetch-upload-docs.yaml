---
- name: Test the fetch-docs role
  hosts: all
  vars:
    src_path: "build/html"
    dst_path: "fetch"
  pre_tasks:
    - name: Create src_dir
      file:
        path: "{{ src_path }}"
        state: directory

    - name: Create a file in the docs directory
      copy:
        dest: "{{ src_path }}/test.txt"
        content: foo
  roles:
    - role: fetch-docs
      srce_path: "{{ src_path }}"
      dstn_path: "{{ dst_path }}"

  post_tasks:
    - name: Ensure that the file exists
      stat:
        path: "{{ src_path }}/test.txt"
      register: test_file
      delegate_to: builder
      failed_when: test_file.stat.exists == False

- name: Upload test
  hosts: localhost
  pre_tasks:
    - name: set variables
      set_fact:
        dest_path: "upload/html"

    - name: create target dir
      file:
        state: directory
        path: "{{ dest_path }}"

- name: Sync executor
  hosts: localhost
  roles:
    - role: upload-docs
      zuul_doc_url: "upload"
      zuul_docserver_root: "html"
      root_files: "build/html"
      index_file: "test.txt"

  tasks:
    - name: Ensure that the file exists on temp dir
      stat:
        path: "{{ dest_path }}/test.txt"
      register: test_file
      failed_when: test_file.stat.exists == False

    # - name: Clean up data
    #   file:
    #     state: absent
    #     path: "{{ dest_path }}"
